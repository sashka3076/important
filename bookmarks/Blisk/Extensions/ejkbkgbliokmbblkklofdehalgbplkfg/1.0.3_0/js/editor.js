var canvasToDataURL,screenshot=chrome.extension.getBackgroundPage().screenshot,shadowDistance=1;localStorage.lastTool||(localStorage.lastTool='house');function Editor_obj(){function d(c){O++,P++,N.length>O&&(N.slice(O),P=O),c||(c={});var d=jQuery.extend(!0,{},c);return d.canvas=t,d.c=v,d=$.extend(!0,d,L),N[O]=d,M=d,M.active=!0,M.color=H,M.lineWidth=I,p(),d}function f(){u=$('<canvas class="tool" style="position:relative"></canvas>').appendTo($('#clipper'));var c=$('<img>').appendTo('#clipper');u.data('img',c),t=u[0],v=t.getContext('2d'),t.width=z.width(),t.height=z.height(),u.data('level',M),M.canvas=t,M.c=v,u.add(c).css({"margin-left":-L.rx1,"margin-top":-L.ry1}),u.add(c).css({position:'absolute',"z-index":J++,left:0,co:z.position().left,top:0,color:z.offset().top-F})}function e(){L.rx1=0,L.rx2=w.width,L.ry1=0,L.ry2=w.height}function g(c){return ans={x:L.rx1+c.pageX-$('#divCanvasData').offset().left+$('#divCanvasData').scrollLeft(),y:L.ry1+c.pageY-$('#divCanvasData').offset().top+$('#divCanvasData').scrollTop()},0>ans.x||0>ans.y?!1:!(c.pageX>$('#divCanvasData').offset().left+$('#divCanvasData').width()-C)&&!(c.pageY>$('#divCanvasData').offset().top+$('#divCanvasData').height()-D)&&!(c.pageX<$('#divCanvasData').offset().left)&&!(c.pageY<$('#divCanvasData').offset().top)&&ans}function h(c){return x1=y1=65535,x2=y2=0,$.each(c,function(c,d){d.x<x1&&(x1=d.x),d.x>x2&&(x2=d.x),d.y<y1&&(y1=d.y),d.y>y2&&(y2=d.y)}),{x1:x1,x2:x2,y1:y1,y2:y2}}function j(){var c=$(t).data('img'),d=$(t);c.css({marginTop:d.css('marginTop'),marginLeft:d.css('marginLeft'),position:'absolute',left:d.css('left'),top:d.css('top'),width:d.css('width'),height:d.css('height')}),c.attr('src',t.toDataURL())}function k(c,d,e,f,g){return d<f?(rx1=d,rx2=f):(rx1=f,rx2=d),e<g?(ry1=e,ry2=g):(ry1=g,ry2=e),M.canvasOffset={x:rx1-7,y:ry1-7},$(c).css({left:rx1-7,top:ry1-7}),c.width=rx2-rx1+25,c.height=ry2-ry1+25,$(c).data('img').css({left:$(c).css('left'),top:$(c).css('top'),width:c.width,height:c.height}),{x:rx1,y:ry1}}function l(){'started'===K.status&&(n(K[K.current].up),n(K[K.current].finish))}function m(c){'undo'===c.type&&'redo'===c.type&&'crop'===c.type||(localStorage.lastTool=c),l(),$('.button [tag='+c+']').trigger('mousedown'),K.current=c}function n(c){$.isFunction(c)&&c()}function o(){canvasWidth=L.rx2-L.rx1,canvasHeight=L.ry2-L.ry1,$('#clipper').css({height:L.ry2-L.ry1,overflow:'hidden',width:L.rx2-L.rx1,position:'absolute'}),G&&($('#canvasId').attr('height',L.ry2-L.ry1),$('#canvasId')[0].getContext('2d').drawImage(G,0,0)),z.css({"margin-left":-L.rx1,"margin-top":-L.ry1}),z.css({clip:'clip.rect('+L.ry1+' '+L.rx2+' '+L.ry2+' '+L.rx1+')'}).css('position','absolute'),$('canvas').add('#clipper img').not('#canvasId').each(function(){$(this).css({"margin-left":-L.rx1,"margin-top":-L.ry1})}),maxWidth=window.innerWidth,maxHeight=window.innerHeight-$('#header').height()-$('#fotter').height(),$('#header').add('#fotter').width(maxWidth),divCanvasData=$('#divCanvasData');var c=canvasHeight;c>maxHeight&&(c=maxHeight),divCanvasData.css({left:canvasWidth>maxWidth?0:maxWidth/2-canvasWidth/2,width:canvasWidth>maxWidth?maxWidth:canvasWidth,height:c,"overflow-x":canvasWidth+16<maxWidth?'hidden':'auto',"overflow-Y":canvasHeight<maxHeight?'hidden':'auto',top:'50%',"margin-top":$('#header').height()/2-c/2+'px'}),D=canvasWidth<maxWidth?0:16,C=canvasHeight<maxHeight?0:16,q()}function p(){$('.button[tag=undo]').attr('status',-1<O?'on':'Disable'),$('.button[tag=undo]')[-1<O?'removeClass':'addClass']('disable'),$('.button[tag=redo]').attr('status',P>O?'on':'Disable'),$('.button[tag=redo]')[P>O?'removeClass':'addClass']('disable'),$('#toolbar .button').each(function(){$(this).attr('title',$(this).attr('tag')),'on'===$(this).attr('status')?($(this).attr({src:'images/drawing/'+$(this).attr('tag')+($(this).attr('tag')===K.current?'On':'Off')+'.png'}).css({cursor:'pointer'}),$(this)[$(this).attr('tag')===K.current?'addClass':'removeClass']('on')):$(this).attr({src:'images/drawing/'+$(this).attr('tag')+'Disable.png'}).css({cursor:'not-allowed'})})}function q(){E=$('#divCanvasData').scrollLeft(),F=$('#divCanvasData').scrollTop()}function r(){$('.linePickerOverlay hr').click(function(){I=parseInt(this.style.height),$('.linePickerOverlay').slideUp()}),$('#LineWidthPicker').mouseenter(function(){var c=$('.linePickerOverlay');c.is(':visible')||c.slideDown()}).mouseleave(function(){$('.linePickerOverlay').slideUp()}),$(document.body).bind('mousedown',function(c){if(0===c.button){var d=g(c);if(d||l(),d&&'text'===K.current&&l(),d&&'ready'===K.status&&K[K.current].begin(d),'page-editor'===c.delegateTarget.id)return!1}}),$(document.body).bind('mousemove',function(c){dime=g(c),$('#divCanvasData').css('default'),$('#divCanvasData').css('cursor','default'),dime&&(('ready'===K.status||'started'===K.status)&&$('#divCanvasData').css('cursor','crosshair'),'started'===K.status&&$.isFunction(K[K.current].move)&&K[K.current].move(dime))}),$(window).resize(o),$(document.body).bind('mouseup',function(c){dime=g(c),K.current&&n(K[K.current].up)}),$('#toolbar .button').click(function(){$this=$(this),'on'===$this.attr('status')&&(m($this.attr('tag')),$.isFunction(K[$this.attr('tag')].click)&&K[$this.attr('tag')].click(),$this.attr({src:'images/drawing/'+$this.attr('tag')+'On.png'}),$this.addClass('on'),p())}),$('#divCanvasData').bind('scroll',q)}function s(){v.strokeStyle='rgba(0,0,0,0.1)',v.moveTo(100,100),v.lineTo(300,300),v.stroke()}var t,u,v,w,z,A,B,C,D,E,F,G,H='#ff0000',I=2,J=5,K={current:'line',status:'ready'},L={rx1:0,rx2:0,ry1:0,ry2:0};K.free={},K.highlight={},K.spray={},K.line={},K.rectangle={},K.full={},K.arrow={},K.star={},K.house={},K.ellipsis={},K.crop={},K.text={},K.undo={},K.redo={};var M,N=[],O=-1,P=-1;K.undo.click=function(){'delete'===M.type?(M.item.add(M.item.data('img')).fadeIn(),M.item.data('deleted',!1),M.hide=null,O--,M=N[O]):'crop'===M.type?(O--,M=N[O],0>O?(L.rx1=L.ry1=0,L.ry2=$('#imgFixForLong').height(),L.rx2=$('#imgFixForLong').width()):(M=N[O],L.rx1=M.rx1,L.rx2=M.rx2,L.ry1=M.ry1,L.ry2=M.ry2),o()):(M.canvas.style.display='none',$(M.canvas).data('img').hide(),O--,M=N[O]),m('house'),p()},K.redo.click=function(){imageChanged=!0,O++,M=N[O],'delete'===M.type?(M.item.add(M.item.data('img')).fadeOut(),M.item.data('deleted',!0),M.hide=!0):'crop'===M.type?(L.rx1=M.rx1,L.rx2=M.rx2,L.ry1=M.ry1,L.ry2=M.ry2,o()):(M.canvas.style.display='',$(M.canvas).data('img').show()),m('house'),p()},this.createLastCanvas=function(c=()=>{}){var d=document.createElement('canvas');d.width=L.rx2-L.rx1,d.height=L.ry2-L.ry1;var e=d.getContext('2d');e.drawImage($('#imgFixForLong')[0],L.rx1,L.ry1,L.rx2-L.rx1,L.ry2-L.ry1,0,0,L.rx2-L.rx1,L.ry2-L.ry1);for(var f=0;f<=O;f++){var g=N[f];g.canvasOffset={x:L.rx1,y:L.ry1},'crop'===g.type||'delete'===g.type||g.hide||K[g.type].draw({canvas:d,ctx:e,data:g})}canvasToDataURL=d.toDataURL(),c(canvasToDataURL)},this.reloadCanvas=function(){screenshot.url&&$('title').html(screenshot.url),e(),o(),p(),$('#toolbar .button[tag='+localStorage.lastTool+']').trigger('click')},this.init=function(){if($('#wColorPicker2_3').wColorPicker({theme:'blue',mode:'hover',showSpeed:300,hideSpeed:300,buttonSize:26,initColor:localStorage.color||'#FF0000',onSelect:function(c){localStorage.color=c,H=c}}).on('mousedown',function(c){return c.stopPropagation(),!1}),function(){$('#divCanvasData').on('mousemove',function(c){'ready'!==K.status&&'text'!==K.current||$('canvas').each(function(e){if(!(2>e)){var f=$(t);gc=f[0].getContext('2d'),x=c.offsetX+c.target.offsetLeft-f.position().left+L.rx1,y=c.offsetY+c.target.offsetTop-f.position().top+L.ry1;var g=!1;if(0<x&&0<y&&x<t.width&&y<t.height&&'none'!==t.style.display){id=gc.getImageData(x,y,1,1).data,g=0;for(var h=0;4>h;h++)0!==id[h]&&(g=!0)}if(g){f.css({border:'2px dahed gray'});var j=f,k=f.data('close')||function(){j.css({border:'none'}),f.data('myClose').remove(),f.data('myClose',!1),f.data('close',!1)};clearTimeout(f.data('time'));var l=setTimeout(k,3e3);if(f.data('close',k),f.data('time',l),f.data('myClose'))return!1;var m=$('<div class="myClose">&times;</div>').css({left:f.position().left+f.width()-10-L.rx1,top:f.position().top-L.ry1,zIndex:1e3});return m=m.appendTo('#divCanvasData').click(function(c){c.stopImmediatePropagation(),j.add(j.data('img')).fadeOut(),m.remove()}).mousedown(function(c){c.stopImmediatePropagation(),d(),M.type='delete',M.item=j,j.data('deleted',!0),j.data('level').hide=!0}),m.position().left>L.rx2-L.rx1&&m.css('left',L.rx2-L.rx1-30),0>m.position().top&&m.css('top',0),f.data('myClose',m),!1}}})})}(),w=document.getElementById('canvasId'),z=$(w),r(),p(),screenshot.canvas){t=$('canvas')[1];const c=$('#imgFixForLong')[0];c.onload=function(){t.width=this.width,t.height=this.height,G=this,t.getContext('2d').drawImage(this,0,0,t.width,t.height),editor.reloadCanvas()};try{c.src=screenshot.canvas.toDataURL()}catch(c){}screenshot.canvas.width=screenshot.canvas.height=1,screenshot.canvas.remove(),screenshot.canvas=null,delete screenshot.canvas}},K.text.begin=function(c){K.status='started',A=c.x,B=c.y,$('#text_helper').remove(),$('<div id=text_helper style="position:absolute;border:none">adf</div>').appendTo('#divCanvasData'),x1=A,y1=B,x2=c.x,y2=c.y,x1<x2?(rx1=x1,rx2=x2):(rx1=x2,rx2=x1),y1<y2?(ry1=y1,ry2=y2):(ry1=y2,ry2=y1),$('#text_helper').css({"z-index":1e4,left:-L.rx1+rx1-8,top:-L.ry1+ry1-8,height:L.ry2-B,width:L.rx2-A}),b=['left','top','z-index','width','height','position','font-weight','width','fontWeight'];var d=$('<textarea></textarea>');for(i in b)d.css(b[i],$('#text_helper').css(b[i]));d.css({"background-color":'transparent',padding:0,margin:0,border:'none',color:H,"font-size":'15pt',"font-weight":'400'}),d.mousedown(function(c){c.stopImmediatePropagation()}),d.appendTo('#divCanvasData').focus(),$('#text_helper').remove(),d.blur(K.text.finish)},K.text.finish=function(){d(),f(),M.type='text',a={text:$('textarea').val(),font:$('textarea').css('font-size')+' '+$('textarea').css('font-family'),"font-size":$('textarea').css('font-size'),"font-weight":$('textarea').css('font-weight'),lineHeight:$('textarea').css('line-height'),width:$('textarea').css('width'),x:A,y:B,direction:$('textarea').css('direction')},M=$.extend(M,a),$('textarea').remove(),K[K.current].draw({canvas:t,ctx:v,data:M},'toolcreate'),K.status='ready',$('textarea').unbind('blur')},K.text.draw=function(c,d){c.ctx.textBaseline='top',c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.font=c.data.font,lineHeight=c.ctx.font=parseInt(c.data['font-size']),check=multiFillText(c.canvas,c.data.text,null,null,parseInt(lineHeight),parseInt(c.data.width)),d&&(k(c.canvas,c.data.x,c.data.y,1e4,1e4),c.canvas.width=check.width,c.canvas.height=check.height+10),c.ctx.textBaseline='top',c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.font=c.data.font,context=c.ctx,context.shadowColor='black',context.shadowBlur=0,context.shadowOffsetX=0,context.shadowOffsetY=0,multiFillText(c.canvas,c.data.text,d?0:c.data.x-L.rx1,d?0:c.data.y-L.ry1,parseInt(lineHeight),parseInt(c.data.width)),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,j()},K.crop.begin=function(c){K.status='started',A=c.x,B=c.y},K.crop.click=function(){o()},K.crop.up=function(){return 100>ry2-ry1+rx2-rx1?void K.crop.draw():void(L.rx1=rx1,L.rx2=rx2,L.ry1=ry1,L.ry2=ry2,d(),M.type='crop',K.crop.draw())},K.crop.draw=function(){$('#crop_helper').remove(),o(),$('#divCanvasData').scrollTop(0).scrollLeft(0),K.status='ready',p()},K.crop.move=function(c){x1=A,y1=B,x2=c.x,y2=c.y,35>$('#divCanvasData').scrollTop()+$('#divCanvasData').height()-c.y&&($('#divCanvasData')[0].scrollTop+=30,c.y+=30),35>$('#divCanvasData').scrollLeft()+$('#divCanvasData').width()-c.x&&($('#divCanvasData')[0].scrollLeft+=30,c.x+=30),35>c.y-$('#divCanvasData').scrollTop()&&($('#divCanvasData')[0].scrollTop-=30,c.y-=30),35>c.x-$('#divCanvasData').scrollLeft()&&($('#divCanvasData')[0].scrollLeft-=30,c.x-=30),x1<x2?(rx1=x1,rx2=x2):(rx1=x2,rx2=x1),y1<y2?(ry1=y1,ry2=y2):(ry1=y2,ry2=y1),$('#crop_helper').remove(),$('<div id=crop_helper><div id=crop_helper_bottom></div><div id=crop_helper_left></div><div id=crop_helper_top></div><div id=crop_helper_right></div></div>').appendTo('#divCanvasData'),$('#crop_helper *').css({"background-color":'blue',opacity:'0.6',position:'absolute',"z-index":10000}),$('#crop_helper_left').css({"ackground-color":'blue',left:0,top:z.position().top,top:0,width:rx1-L.rx1,height:z.height()+F}),$('#crop_helper_top').css({"ackground-color":'red',left:rx1-L.rx1,top:0,width:L.rx2-(rx1-L.rx1),height:ry1-L.ry1}),$('#crop_helper_bottom').css({"ackground-color":'yellow',left:rx1-L.rx1,top:ry2-L.ry1,width:L.rx2-(rx1-L.rx1),height:L.ry2-ry2}),$('#crop_helper_right').css({"ackground-color":'green',left:rx2-L.rx1,top:ry1-L.ry1,width:L.rx2-(rx2-L.rx1),height:ry2-ry1})},K.spray.begin=function(c){K.status='started',d(),f(),M.type='spray',M.points=[],K.spray.move(c)},K.spray.move=function(d){for(var e=Math.round,f=35*v.lineWidth;0<f;f--){var g=d.x+e(Math.random()*(15*v.lineWidth)-2*v.lineWidth),j=d.y+e(Math.random()*(15*v.lineWidth)-2*v.lineWidth);M.points.push({x:g,y:j})}ans=h(M.points),k(t,ans.x1,ans.y1,ans.x2,ans.y2),K[K.current].draw({canvas:t,ctx:v,data:M})},K.spray.draw=function(c){f=c.ctx.getImageData(0,0,c.canvas.width,c.canvas.height),g=f.data;for(var d=0;d<c.data.points.length;d++)e=4*(parseInt(c.data.points[d].y-c.data.canvasOffset.y-1)*c.canvas.width),e+=4*parseInt(c.data.points[d].x-c.data.canvasOffset.x),g[e]=parseInt(c.data.color.slice(4,-1).split(',')[0]),g[e+1]=parseInt(c.data.color.slice(4,-1).split(',')[1]),g[e+2]=parseInt(c.data.color.slice(4,-1).split(',')[2]);for(var e,f=c.ctx.getImageData(0,0,c.canvas.width,c.canvas.height),g=f.data,h=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c.data.color),k=[parseInt(h[1],16),parseInt(h[2],16),parseInt(h[3],16)],d=0;d<c.data.points.length;d++)e=4*(parseInt(c.data.points[d].y-c.data.canvasOffset.y-10)*c.canvas.width),e+=4*parseInt(c.data.points[d].x-c.data.canvasOffset.x-10),g[e]=k[0],g[e+1]=k[1],g[e+2]=k[2],g[e+3]=255;c.ctx.putImageData(f,0,0),j()},K.spray.up=function(){K.status='ready'},K.free.up=function(){K.status='ready'},K.free.begin=function(c){K.status='started',d(),f(),M.type='free',M.points=[],K.free.move(c)},K.free.move=function(d){M.points.push({x:d.x,y:d.y}),++t.height,--t.height,ans=h(M.points),k(t,ans.x1,ans.y1,ans.x2,ans.y2),K[K.current].draw({canvas:t,ctx:v,data:M})},K.free.draw=function(c){context=c.ctx,context.shadowBlur=5,context.shadowOffsetX=5,context.shadowOffsetY=5,context.lineWidth=c.data.lineWidth,c.ctx.beginPath(),c.ctx.strokeStyle=c.data.color,c.ctx.globalAlpha=1,c.ctx.fillStyle=c.data.color;for(var d=1;d<c.data.points.length;d++)c.ctx.lineTo(c.data.points[d].x-c.data.canvasOffset.x,c.data.points[d].y-c.data.canvasOffset.y);c.ctx.stroke(),c.ctx.closePath(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,j()},K.highlight.up=function(){K.status='ready'},K.highlight.begin=function(c){K.status='started',d(),f(),M.type='highlight',M.points=[],K.highlight.move(c)},K.highlight.move=function(d){M.points.push({x:d.x,y:d.y}),++t.height,--t.height,ans=h(M.points),k(t,ans.x1,ans.y1,ans.x2,ans.y2),K[K.current].draw({canvas:t,ctx:v,data:M})},K.highlight.draw=function(c){context=c.ctx,context.shadowBlur=5,context.shadowOffsetX=5,context.shadowOffsetY=5,context.globalAlpha=0.45,c.ctx.lineWidth=20,c.ctx.beginPath(),c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color;for(var d=1;d<c.data.points.length;d++)c.ctx.lineTo(c.data.points[d].x-c.data.canvasOffset.x,c.data.points[d].y-c.data.canvasOffset.y);c.ctx.stroke(),c.ctx.closePath(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,j()},K.line.begin=function(c){K.status='started',d(),f(),M.type='line',M.start={x:c.x,y:c.y}},K.line.move=function(d){M.end={x:d.x,y:d.y},++t.height,--t.height,k(t,M.start.x,M.start.y,M.end.x,M.end.y),K[K.current].draw({canvas:t,ctx:v,data:M})},K.line.draw=function(c){c.data.start&&c.data.end&&(c.ctx.beginPath(),c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.lineWidth=c.data.lineWidth,s=function(d,e,f,g,h){c.ctx.lineWidth=c.data.lineWidth,h?(c.ctx.strokeStyle='000',c.ctx.globalAlpha=0.2):(s(d+shadowDistance,e+shadowDistance,f+shadowDistance,g+shadowDistance,!0),c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.globalAlpha=1),c.ctx.beginPath(),c.ctx.moveTo(d,e),c.ctx.lineTo(f,g),c.ctx.stroke(),c.ctx.closePath()},context=c.ctx,context.shadowBlur=5,context.shadowOffsetX=5,context.shadowOffsetY=5,s(c.data.start.x-c.data.canvasOffset.x,c.data.start.y-c.data.canvasOffset.y,c.data.end.x-c.data.canvasOffset.x,c.data.end.y-c.data.canvasOffset.y),c.ctx.lineCap='round',c.ctx.stroke(),c.ctx.closePath(),context=c.ctx,context.shadowBlur=0,context.shadowOffsetX=0,context.shadowOffsetY=0,j())},K.line.up=function(){K.status='ready'};var Q=30;K.ellipsis.begin=function(c){K.status='started',d(),f(),c.x-=Q/2,c.y-=Q/2,M.type='ellipsis',M.start={x:c.x,y:c.y},M.end={x:c.x+Q,y:c.y+Q},K.ellipsis.move({x:c.x+Q,y:c.y+Q})},K.ellipsis.move=function(d){M.end={x:d.x,y:d.y},++t.height,--t.height,k(t,M.start.x,M.start.y,M.end.x,M.end.y),K[K.current].draw({canvas:t,ctx:v,data:M})},K.ellipsis.draw=function(c){c.data.start&&c.data.end&&(c.ctx.beginPath(),c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.ellipsisWidth=c.data.ellipsisWidth,drawEllipsis=function(d,e,f,g,h){if(c.ctx.lineWidth=c.data.lineWidth,!h){drawEllipsis(d+shadowDistance,e+shadowDistance,f+shadowDistance,g+shadowDistance,!0),c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.globalAlpha=1,c.ctx.beginPath();var j=4*((1.4142135623730951-1)/3),k=(f-d)/2,l=(g-e)/2,m=d+k,n=e+l,o=c.ctx;o.beginPath(),o.moveTo(m,n-l),o.bezierCurveTo(m+j*k,n-l,m+k,n-j*l,m+k,n),o.bezierCurveTo(m+k,n+j*l,m+j*k,n+l,m,n+l),o.bezierCurveTo(m-j*k,n+l,m-k,n+j*l,m-k,n),o.bezierCurveTo(m-k,n-j*l,m-j*k,n-l,m,n-l),c.ctx.stroke(),c.ctx.closePath()}},drawEllipsis(c.data.start.x-c.data.canvasOffset.x,c.data.start.y-c.data.canvasOffset.y,c.data.end.x-c.data.canvasOffset.x,c.data.end.y-c.data.canvasOffset.y),c.ctx.ellipsisCap='round',c.ctx.stroke(),c.ctx.closePath(),j())},K.ellipsis.up=function(){K.status='ready'};var R=30;K.rectangle.begin=function(c){K.status='started',d(),f(),c.x-=R/2,c.y-=R/2,M.type='rectangle',M.start={x:c.x+15,y:c.y+15},M.end={x:c.x+R,y:c.y+R},K.rectangle.move({x:c.x+R,y:c.y+R})},K.rectangle.move=function(d){M.end={x:d.x,y:d.y},++t.height,--t.height,k(t,M.start.x,M.start.y,M.end.x,M.end.y),K[K.current].draw({canvas:t,ctx:v,data:M})},K.rectangle.draw=function(c){function d(e,f,g,h,j){(c.ctx.lineWidth=c.data.lineWidth,!j)&&(d(e+shadowDistance,f+shadowDistance,g+shadowDistance,h+shadowDistance,!0),c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.globalAlpha=1,c.ctx.beginPath(),c.ctx.moveTo(e,f),c.ctx.lineTo(e,h),c.ctx.lineTo(g,h),c.ctx.lineTo(g,f),c.ctx.lineTo(e,f),'full'===c.data.type?c.ctx.fill():c.ctx.stroke(),c.ctx.closePath())}c.data.start&&c.data.end&&(context=c.ctx,context.shadowBlur=5,context.shadowOffsetX=5,context.shadowOffsetY=5,d(c.data.start.x-c.data.canvasOffset.x,c.data.start.y-c.data.canvasOffset.y,c.data.end.x-c.data.canvasOffset.x,c.data.end.y-c.data.canvasOffset.y),context=c.ctx,context.shadowBlur=0,context.shadowOffsetX=0,context.shadowOffsetY=0,c.ctx.lineCap='round',j())},K.rectangle.up=function(){K.status='ready'},K.full.begin=function(c){K.status='started',d(),f(),M.type='full',c.x-=R/2,c.y-=R/2,M.start={x:c.x+15,y:c.y+15},M.end={x:c.x+R,y:c.y+R},K.full.move({x:c.x+R,y:c.y+R})},K.full.move=K.rectangle.move,K.full.draw=K.rectangle.draw,K.full.up=K.rectangle.up;var S=15;K.star.begin=function(c){K.status='started',d(),f(),M.type='star',M.start={x:c.x-S+15,y:c.y-S+15},M.end={x:c.x+S,y:c.y+S},K.star.move(c)},K.star.move=function(d){M.end={x:d.x,y:d.y},++t.height,--t.height,k(t,M.start.x-(M.end.x-M.start.x)/2,M.start.y-(M.end.y-M.start.y)/2,M.end.x+2*(M.end.x-M.start.x),M.end.y+2*(M.end.y-M.start.y)),K[K.current].draw({canvas:t,ctx:v,data:M})},K.star.draw=function(c){c.data.start&&c.data.end&&(function(d,e,f,g){c.ctx.lineWidth=c.data.lineWidth,c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.globalAlpha=1,c.ctx.drawSvg('<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="200px" height="200px" viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve"><g>\t<path d="M98.88,21.851l23.207,47.022l1.629,3.3l3.642,0.529l51.893,7.541l-37.549,36.602l-2.636,2.569l0.622,3.627l8.864,51.683l-46.414-24.402l-3.258-1.712l-3.257,1.712l-46.414,24.402l8.865-51.683l0.622-3.628l-2.635-2.568L18.51,80.243l51.893-7.541l3.642-0.529l1.629-3.3L98.88,21.851 M98.88,6.034L69.396,65.775l-65.929,9.58l47.707,46.502L39.912,187.52l58.968-31.002l58.969,31.002l-11.262-65.662l47.705-46.502l-65.928-9.58L98.88,6.034L98.88,6.034z"/></g></svg>',d,e,2*(f-d),2*(g-e))}(c.data.start.x-c.data.canvasOffset.x,c.data.start.y-c.data.canvasOffset.y,c.data.end.x-c.data.canvasOffset.x,c.data.end.y-c.data.canvasOffset.y),j())},K.star.up=function(){K.status='ready'};K.house.begin=function(){},K.house.move=function(){},K.house.draw=function(){},K.house.up=function(){},K.arrow.begin=function(c){K.status='started',d(),f(),M.type='arrow',M.start={x:c.x,y:c.y}},K.arrow.move=function(d){M.end={x:d.x,y:d.y},++t.height,--t.height,k(t,M.start.x,M.start.y,M.end.x,M.end.y),K[K.current].draw({canvas:t,ctx:v,data:M})},K.arrow.draw=function(c){function d(e,f,g,h,j){if(c.ctx.lineWidth=c.data.lineWidth,j)return c.ctx.strokeStyle='000',void(c.ctx.globalAlpha=0.2);d(e+shadowDistance,f+shadowDistance,g+shadowDistance,h+shadowDistance,!0),c.ctx.strokeStyle=c.data.color,c.ctx.fillStyle=c.data.color,c.ctx.globalAlpha=1,c.ctx.beginPath(),c.ctx.moveTo(e,f),c.ctx.lineTo(g,h);var k=8,l=7,m=7,n=g-e,o=h-f,p=Math.sqrt(n*n+o*o);c.ctx.lineTo(g-o*k/p-n*l/p,h+n*k/p-o*l/p),c.ctx.lineTo(g+n*m/p,h+o*m/p),c.ctx.lineTo(g+o*k/p-n*l/p,h-n*k/p-o*l/p),c.ctx.lineTo(g,h),c.ctx.stroke(),c.ctx.closePath()}c.data.start&&c.data.end&&(d(c.data.start.x-c.data.canvasOffset.x,c.data.start.y-c.data.canvasOffset.y,c.data.end.x-c.data.canvasOffset.x,c.data.end.y-c.data.canvasOffset.y),c.ctx.lineCap='round',j())},K.arrow.up=function(){K.status='ready'},window.changeTool=m}var editor=new Editor_obj;editor.window=window,editor.close=window.close,$(function(){editor.init(),editor.appick||editor.intent||setTimeout(screenshot.createScreenShot,0)});var multiFillText=function(c,d,e,f,g,h){var j=c.getContext('2d'),k=null!==e&&null!==f;d=d.replace(/(\r\n|\n\r|\r|\n)/g,'\n'),sections=d.split('\n');var l,m,n,o,p=0,q=0,r=function(c){k&&j.fillText(c,e,f+g*p),p++,n=j.measureText(c).width,n>q&&(q=n)};for(l=0;l<sections.length;l++){for(o=sections[l].split(' '),index=1;0<o.length&&index<=o.length;)m=o.slice(0,index).join(' '),n=j.measureText(m).width,n>h?(1===index?(m=o.slice(0,1).join(' '),o=o.splice(1)):(m=o.slice(0,index-1).join(' '),o=o.splice(index-1)),r(m),index=1):index++;0<index&&r(o.join(' '))}if(maxHeight=g*p,!k)return{height:maxHeight,width:q}};function saveFile(c,d,e=()=>{},f=()=>{}){function g(){var c='filesystem:chrome-extension://'+chrome.runtime.id+'/temporary/'+d;e(c)}const h=function(c){for(var d=atob(c.split(',')[1]),e=c.split(',')[0].split(':')[1].split(';')[0],f=new ArrayBuffer(d.length),g=new Uint8Array(f),h=0;h<d.length;h++)g[h]=d.charCodeAt(h);return new Blob([f],{type:e})}(c);var j=h.size+512,k=window.requestFileSystem||window.webkitRequestFileSystem;k(window.TEMPORARY,j,function(c){c.root.getFile(d,{create:!0},function(c){c.createWriter(function(c){c.onwriteend=g,c.write(h)},f)},f)},f)}setTimeout(()=>{const c=new Date().toISOString().replace(/\.\w+/,'').replace(/:/g,'-')+'.png';editor.createLastCanvas((d)=>saveFile(d,c))},2e3),$(function(){new Toolbar({plugins:[],element:document.getElementById('toolbarContainer'),namespace:'editor',enlargable:!1,page_title:screenshot.title,page_url:screenshot.url,doNotRenderDefaults:!0,whiteIcons:!0,button_size:20,icon_base:'images/',position:'static',type:'image',theme:!0,request:function(c){editor.createLastCanvas(function(d){c(d)})}}),changeTool('house'),$('.save').on('click',function(){editor.createLastCanvas(),chrome.downloads.download({url:canvasToDataURL,filename:Date.now()+'.png',saveAs:!0})}),$('.save-to-pdf').on('click',function(){editor.createLastCanvas();const c=20,d=new Image,e=595.28,f=841.89;let g=0.5,h=e,j=f,k='p';d.src=canvasToDataURL,d.onload=()=>{d.width*g>h-2*c&&(k='l',h=f,j=e,g=(h-2*c)/d.width);var l=0,m=document.createElement('canvas');const n=new jsPDF(k,'pt');for(;l<d.height;){0!=l&&n.addPage();const e=m.getContext('2d');m.width=d.width,m.height=(j-c)/g,e.rect(0,0,m.width,m.height),e.fillStyle='white',e.fill(),e.drawImage(d,0,l,d.width,d.height-l,0,0,d.width,d.height-l);const f=m.toDataURL('image/jpeg',1);n.addImage(f,'JPEG',c/2,c/2,m.width*g,m.height*g),l+=m.height}chrome.downloads.download({url:n.output('datauristring'),filename:Date.now()+'.pdf',saveAs:!0})}}),$('.buttons .copy').on('click',function(){changeTool('house'),$('.button[tag]').removeClass('on'),editor.createLastCanvas(),$('.copy-modal').remove(),$(`            <div class="copy-modal">                <div class="copy-modal-box">                    <div class="copy-modal-close">✕</div>                    <h2>Right click the image and choose "Copy Image" for copying the image to the clipboard (buffer).</h2>                    <img src="${canvasToDataURL}">                </div>            </div>`).appendTo(document.body)}),$(document.body).on('click','.copy-modal',(c)=>{c.target.closest('.copy-modal-box')||$('.copy-modal').remove()}),$(document.body).on('click','.copy-modal-close',()=>$('.copy-modal').remove()),$(document.body).on('keyup',(c)=>{27===c.keyCode&&$('.copy-modal').remove()})});
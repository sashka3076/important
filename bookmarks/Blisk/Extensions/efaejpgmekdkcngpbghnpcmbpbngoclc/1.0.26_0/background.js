var cfExtensionClass=function(){this.state=[],this.init=function(e,t){0!=e.url.indexOf("https://chrome.google.com")&&0!=e.url.indexOf("chrome://")?(storage.init(),chrome.tabs.sendMessage(e.id,{type:"hello"},function(n){n?"function"==typeof t&&t():(chrome.tabs.executeScript(e.id,{file:"resources/jquery-3.2.1.min.js"}),chrome.tabs.executeScript(e.id,{file:"cf.min.js"}),chrome.tabs.insertCSS(e.id,{file:"css/background.css"}),window.setTimeout(function(){"function"==typeof t&&t()},1e3))})):alert("CanvasFlip Inspector doesn't work on Google Chrome webstore!")},this.toggle=function(e){cfExtension.init(e,function(){chrome.tabs.executeScript(e.id,{code:"CFInspectToggle("+e.id+")"})})},this.openCollaboratorView=function(e,t){cfExtension.init(e,function(){chrome.tabs.executeScript(e.id,{code:"CFOpenCollaboratorView("+e.id+',"'+t+'")'}),chrome.tabs.executeScript(e.id,{code:"CFInspectHideLoading()"})})},this.inspectThisElement=function(e,t){cfExtension.init(t,function(){chrome.tabs.executeScript(t.id,{code:"CFInspectThisElement("+t.id+")"})})}},storage=new Storage,cfExtension=new cfExtensionClass,cfInspectorContextMenu=chrome.contextMenus.create({title:"CanvasFlip Inspect",contexts:["all"],onclick:cfExtension.inspectThisElement});function CaptureElement(e,t){var n=t.devicePixelRatio&&1!==t.devicePixelRatio?1/t.devicePixelRatio:1;1!==n&&(t.top=t.top/n,t.left=t.left/n,t.width=t.width/n,t.height=t.height/n),chrome.tabs.get(e,function(n){chrome.tabs.captureVisibleTab(n.windowId,{format:"png"},function(n){var r=document.createElement("canvas"),o=new Image;o.onload=function(){r.width=t.width,r.height=t.height,r.getContext("2d").drawImage(o,t.left,t.top,t.width,t.height,0,0,t.width,t.height);var n=r.toDataURL("image/png");chrome.tabs.sendMessage(e,{type:"capture_element_success",image:n})},o.src=n})})}function OpenReviewURL(e,t,n){var r=null;chrome.tabs.onUpdated.addListener(function n(o,a,i){if(o==e&&(null==r&&(r=window.setInterval(function(){try{chrome.tabs.executeScript(o,{code:"CFInspectShowLoading()"})}catch(e){}},1e3)),"complete"==a.status)){chrome.tabs.onUpdated.removeListener(n);try{null!=r&&(window.clearInterval(r),r=null)}catch(e){}cfExtension.openCollaboratorView(i,t)}}),chrome.tabs.update(e,{url:n},function(){})}chrome.runtime.onInstalled.addListener(function(e){"install"==e.reason&&chrome.tabs.create({url:"option.html"}),"update"==e.reason&&storage.updateToVersion1()}),chrome.runtime.setUninstallURL("https://canvasflipsurvey.typeform.com/to/bfkafA",function(){}),chrome.browserAction.onClicked.addListener(function(e){cfExtension.toggle(e)}),chrome.tabs.onUpdated.addListener(function(e,t,n){if("complete"==t.status){if(0==n.url.indexOf("https://chrome.google.com")||0==n.url.indexOf("chrome://")||0==n.url.indexOf("chrome-extension://"))return;chrome.tabs.executeScript(n.id,{file:"resources/contextmenu.js"})}}),chrome.runtime.onMessage.addListener(function(e,t,n){switch(e.type){case"review-url":OpenReviewURL(t.tab.id,e.uuid,e.url);break;case"ga":"undefined"!=typeof ga&&ga("send",{hitType:e.hitType,eventCategory:e.eventCategory,eventAction:e.eventAction,eventLabel:e.eventLabel});break;case"change_attr":return storage.updateAttr({url:e.url,selector:e.selector,attr:e.attr,old:e.old,new:e.new,date:e.date},function(e){n(e)}),!0;case"change_css":return storage.updateCSS({url:e.url,selector:e.selector,key:e.key,value:e.value,date:e.date},function(e){n(e)}),!0;case"read_css":return storage.readCSSByURL(e.url,function(e){n(e)}),!0;case"read_attr":return storage.readAttrByURL(e.url,function(e){n(e.data)}),!0;case"read_attr_original":return storage.readAttrBySelector(e.url,e.selector,function(e){n(e)}),!0;case"read_attr_for_delete":return storage.readAttrByURL(e.url,function(e){n(e)}),!0;case"read_url":return storage.readURL(function(e){n(e)}),!0;case"read_all":return storage.readAllByURL(e.url,function(e){n(e)}),!0;case"sync_all":return storage.readAllByURL(e.url,function(t){n({is_share:e.is_share,data:t})}),!0;case"delete_all":storage.deleteAllCSS(e.url),storage.deleteAllAttr(e.url);break;case"get_screenshot":return chrome.tabs.captureVisibleTab(function(e){n(e)}),!0;case"capture_element":CaptureElement(t.tab.id,e.dimensions)}}),chrome.runtime.onMessageExternal.addListener(function(e,t,n){switch(e.type){case"check-active":n({status:!0});break;case"activate":cfExtension.toggle(t.tab);break;case"review-url":OpenReviewURL(t.tab.id,e.uuid,e.url)}return!0});
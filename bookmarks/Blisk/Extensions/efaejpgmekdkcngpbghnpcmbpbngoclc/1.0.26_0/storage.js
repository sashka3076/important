var Storage=function(){this.old_database="CF_VI_DB",this.database="CF_DB_1",this.db=null,this.version=1,this.css=[],this.updateToVersion1=function(t){var e=this,a=new Dexie(e.old_database);a.open().then(function(){e.db=new Dexie(e.database),e.db.open().then(function(t){}).catch("NoSuchDatabaseError",function(t){e.createDB(function(){a.table("cf_css").toArray(function(t){for(var a=0;a<t.length;a++){var r={url:t[a].url,selector:t[a].selector,key:t[a].key,value:t[a].value,date:Math.floor(Date.now()/1e3)};e.db.table("cf_css").add(r)}}),a.table("cf_text").toArray(function(t){for(var a=0;a<t.length;a++){var r={url:t[a].url,selector:t[a].selector,attr:"html",old:t[a].old_text,new:t[a].new_text,date:Math.floor(Date.now()/1e3)};e.db.table("cf_attr").add(r)}})})}).catch(function(t){console.error("storage exception: "+t)})}).catch("NoSuchDatabaseError",function(t){}).catch(function(t){console.error("storage exception: "+t)})},this.init=function(t){var e=this;e.db=new Dexie(e.database),e.db.open().then(function(t){}).catch("NoSuchDatabaseError",function(t){e.createDB()}).catch(function(t){console.error("storage exception: "+t)})},this.createDB=function(t){var e=this;e.db=new Dexie(e.database),e.db.version(1).stores({cf_css:"++id, url, selector, key, value, date, [url+selector+key]",cf_attr:"++id, url, selector, attr, old, new, date, [url+selector], [url+selector+attr]"}),e.openDB(),"function"==typeof t&&t()},this.openDB=function(){this.db.open().then(function(t){t.tables.forEach(function(t){})}).catch(function(t){console.error("Open failed: "+t)})},this.closeDB=function(){this.db.close()},this.updateAttr=function(t,e){var a=this;a.db.table("cf_attr").where("[url+selector+attr]").equals([t.url,t.selector,t.attr]).toArray(function(r){var n=!1,o=!1;if(r.length>0){if(null!=r[0].date&&t.date>r[0].date&&(a.db.table("cf_attr").update(r[0].id,{new:t.new,date:t.date}),o=!0),r.length>1)for(var c=0;c<r.length;c++)a.db.table("cf_attr").delete(r[c].id)}else a.db.table("cf_attr").add(t),n=!0;"function"==typeof e&&e({is_created:n,is_updated:o})})},this.readAttrByURL=function(t,e){this.db.table("cf_attr").where("url").equalsIgnoreCase(t).toArray(function(a){"function"==typeof e&&e({url:t,data:a})})},this.readAttrBySelector=function(t,e,a){this.db.table("cf_attr").where("[url+selector]").equals([t,e]).toArray(function(t){"function"==typeof a&&a(t)})},this.deleteAllAttr=function(t){this.db.table("cf_attr").where("url").equalsIgnoreCase(t).delete()},this.updateCSS=function(t,e){var a=this;a.db.table("cf_css").where("[url+selector+key]").equals([t.url,t.selector,t.key]).toArray(function(r){var n=!1,o=!1;if(r.length>0){if(null!=r[0].date&&t.date>r[0].date&&(a.db.table("cf_css").update(r[0].id,{value:t.value,date:t.date}),o=!0),r.length>1)for(var c=0;c<r.length;c++)a.db.table("cf_css").delete(r[c].id)}else a.db.table("cf_css").add(t),n=!0;"function"==typeof e&&e({is_created:n,is_updated:o})})},this.readCSSById=function(t,e){this.db.table("cf_css").get(t,e)},this.readCSSByURL=function(t,e){this.db.table("cf_css").where("url").equalsIgnoreCase(t).toArray(function(t){"function"==typeof e&&e(t)})},this.deleteCSS=function(t){this.db.table("cf_css").delete(t)},this.deleteAllCSS=function(t){this.db.table("cf_css").where("url").equalsIgnoreCase(t).delete()},this.readAllByURL=function(t,e){var a=this,r={};a.db.table("cf_css").where("url").equalsIgnoreCase(t).toArray(function(n){r.css=n,a.db.table("cf_attr").where("url").equalsIgnoreCase(t).toArray(function(t){"function"==typeof e&&(r.attr=t,e(r))})})},this.getDistinctUrls=function(t,e){for(var a=0;a<e.length;a++){for(var r=!1,n=0;n<t.length;n++)t[n]==e[a].url&&(r=!0);r||t.push(e[a].url)}return t},this.readURL=function(t){var e=this,a=[];e.db.table("cf_css").toCollection().toArray(function(r){a=e.getDistinctUrls([],r),e.db.table("cf_attr").toCollection().toArray(function(r){"function"==typeof t&&(a=e.getDistinctUrls(a,r),t(a))})})}};